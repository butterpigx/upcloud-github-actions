name: Build & Deploy Hugo Site

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Initialize Hugo site if not exists
        run: |
          if [ ! -f "config.toml" ] && [ ! -f "config.yaml" ] && [ ! -f "config.json" ]; then
            hugo new site . --force
            git clone https://github.com/theNewDynamic/gohugo-theme-ananke themes/ananke
            echo 'theme = ["ananke"]' >> config.toml
            mkdir -p content/posts
            cat > content/posts/my-first-post.md << EOL
          ---
          title: "My First Post"
          date: 2023-01-01
          draft: false
          ---

          This is my first Hugo post!
          EOL
            cat > content/_index.md << EOL
          ---
          title: "Welcome to My Hugo Site"
          ---

          This is the homepage of my Hugo site.
          EOL
          fi

      - name: Build Hugo site
        run: |
          hugo --minify
          ls -la public
          cat public/index.html

      - name: Install Nginx on UpCloud
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            sudo apt update
            sudo apt install -y nginx
            sudo systemctl start nginx
            sudo systemctl enable nginx
            
            echo "server {
                listen 80;
                server_name $(curl -s -4 ifconfig.me);
                root /var/www/hugo-site;
                index index.html;
                location / {
                    try_files \$uri \$uri/ =404;
                }
            }" | sudo tee /etc/nginx/sites-available/hugo-site
            
            sudo ln -sf /etc/nginx/sites-available/hugo-site /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl reload nginx
            
            sudo mkdir -p /var/www/hugo-site
            sudo chown -R www-data:www-data /var/www/hugo-site
            sudo chmod -R 755 /var/www/hugo-site

      - name: Deploy to UpCloud
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "public/*"
          target: "/var/www/hugo-site"
          strip_components: 1

      - name: Finalize deployment and set permissions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            sudo chown -R www-data:www-data /var/www/hugo-site
            sudo chmod -R 755 /var/www/hugo-site
            sudo find /var/www/hugo-site -type d -exec chmod 755 {} \;
            sudo find /var/www/hugo-site -type f -exec chmod 644 {} \;
            ls -la /var/www/hugo-site
            cat /var/www/hugo-site/index.html
            sudo nginx -t
            sudo systemctl restart nginx
            echo "Hugo site deployed successfully"
            echo "You can now access your site at http://$(curl -s -4 ifconfig.me)"
